<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>RAG Control Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f6f8; }
    h1 { margin: 0; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .scheduler-actions { display: flex; gap: 8px; align-items: center; }
    .scheduler-actions form { margin: 0; }
    button { cursor: pointer; }
    section { background: #fff; border-radius: 8px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
    form { margin-bottom: 8px; }
    textarea { width: 100%; height: 240px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid #e0e0e0; }
    .flash { background: #eef5ff; border: 1px solid #b3d0ff; padding: 8px; margin-bottom: 6px; }
    .env-pair { display: flex; gap: 8px; margin-bottom: 4px; }
    .env-pair input { width: 50%; }
    .grid-two { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
    .grid-prompts-log { display: grid; grid-template-columns: 0.4fr 0.6fr; gap: 16px; align-items: stretch; }
    @media (max-width: 900px) { .grid-prompts-log { grid-template-columns: 1fr; } }
    .grid-prompts-log section { display: flex; flex-direction: column; height: 100%; }
    .prompt-area form { display: flex; flex-direction: column; gap: 8px; height: 100%; }
    .search-layout { display: grid; grid-template-columns: 2fr 3fr; gap: 16px; align-items: start; }
    .search-box { display: flex; flex-direction: column; gap: 8px; }
    .results-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
    .result-group { border: 1px solid #d6d6d6; background: #f8fafc; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
    .group-header { width: 100%; text-align: left; display: flex; justify-content: space-between; gap: 8px; align-items: center; padding: 10px; background: #eef5ff; border: none; cursor: pointer; }
    .group-header:hover { background: #e1edff; }
    .group-meta { display: flex; flex-direction: column; gap: 2px; }
    .group-title { font-weight: bold; }
    .group-sub { color: #4a5568; font-size: 0.9em; }
    .toggle-pill { background: #dbeafe; color: #1d4ed8; border: 1px solid #bfdbfe; border-radius: 12px; padding: 4px 8px; font-size: 0.85em; }
    .points-list { list-style: none; padding: 0 10px 10px 10px; margin: 0; display: flex; flex-direction: column; gap: 6px; }
    .point-item { width: 100%; text-align: left; border: 1px solid #d6d6d6; background: #fff; border-radius: 6px; padding: 8px; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
    .point-item:hover { border-color: #8ab4f8; background: #eef3ff; }
    .point-item.active { border-color: #1d4ed8; background: #e0ecff; }
    .point-title { font-weight: bold; }
    .point-sub { color: #4a5568; font-size: 0.9em; }
    .detail-panel { border: 1px solid #d6d6d6; border-radius: 8px; padding: 12px; background: #fdfefe; min-height: 220px; white-space: pre-wrap; word-break: break-word; }
    .detail-panel pre { white-space: pre-wrap; word-break: break-word; }
    #detail-content { white-space: pre-wrap; word-break: break-word; }
    .detail-header { font-weight: bold; margin-bottom: 6px; }
    .textarea-log { height: 100%; min-height: 360px; flex: 1; }
    .prompt-area textarea { height: 160px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>RAG Control Panel</h1>
    <div class="scheduler-actions">
      <form method="post" action="{{ url_for('start_scheduler') }}">
        <button type="submit">Start scheduler</button>
      </form>
      <form method="post" action="{{ url_for('stop_scheduler') }}">
        <button type="submit">Stop scheduler</button>
      </form>
    </div>
  </div>
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for msg in messages %}<div class="flash">{{ msg }}</div>{% endfor %}
    {% endif %}
  {% endwith %}

  <div class="grid-prompts-log">
    <section class="prompt-area">
      <h2>Prompts</h2>
      <form method="post" action="{{ url_for('update_prompts') }}">
        <label for="prompt_relevance">Relevance prompt</label>
        <textarea id="prompt_relevance" name="prompt_relevance">{{ prompts.relevance }}</textarea>
        <label for="prompt_chunking">Chunking prompt</label>
        <textarea id="prompt_chunking" name="prompt_chunking">{{ prompts.chunking }}</textarea>
        <label for="prompt_context">Context prompt</label>
        <textarea id="prompt_context" name="prompt_context">{{ prompts.context }}</textarea>
        <button type="submit">Save prompts</button>
      </form>
    </section>

    <section class="log-area">
      <h2>Log (latest 50 lines, newest first)</h2>
      <textarea class="textarea-log" id="log-display" readonly>{{ log_preview }}</textarea>
    </section>
  </div>

  <section>
    <h2>Search Qdrant ({{ qdrant_collection }})</h2>
    <div class="search-layout">
      <div class="search-box">
        <form method="post" action="{{ url_for('search') }}">
          <label>Document name contains:</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="text" name="search_term" value="{{ search_term or '' }}" style="flex:1" />
            <button type="submit">Search</button>
          </div>
        </form>
        {% if search_error %}
          <div class="flash">{{ search_error }}</div>
        {% endif %}
        <div id="results-area"></div>
      </div>

      <div>
        <div class="detail-panel" id="result-detail">
          <div class="detail-header">Result details</div>
          <div id="detail-content">Select a result to view its payload.</div>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h2>Delete by file_id</h2>
    <form method="post" action="{{ url_for('delete_file') }}">
      <input type="text" name="file_id" placeholder="file_id" />
      <button type="submit">Delete</button>
    </form>
    <p>Removes Qdrant points, marks the entry in state.db, and deletes matching images in Nextcloud (documents remain unchanged).</p>
  </section>

  <section>
    <h2>Environment variables & prompts</h2>
    <form method="post" action="{{ url_for('update_env') }}">
      {% for key, value in env_values.items() %}
      <div class="env-pair">
        <input type="text" readonly value="{{ key }}" />
        <input type="text" name="env_{{ key }}" value="{{ value }}" />
      </div>
      {% endfor %}
      <button type="submit">Update .env.local</button>
    </form>
    <form method="post" action="{{ url_for('add_env_var') }}">
      <input type="text" name="new_key" placeholder="NEW_KEY" />
      <input type="text" name="new_value" placeholder="value" />
      <button type="submit">Add variable</button>
    </form>
    <details>
      <summary>Currently active environment</summary>
      <pre>{{ current_env|format_payload }}</pre>
    </details>
  </section>

  <section>
    <h2>Reset RAG</h2>
    <form method="post" action="{{ url_for('reset_all') }}">
      <label><input type="checkbox" name="restore_defaults" /> Restore defaults from .env.local.example</label><br/>
      <button type="submit" onclick="return confirm('This will delete Qdrant data, state.db, and Nextcloud images. Continue?');">Reset everything</button>
    </form>
    <p>Deletes all Qdrant entries, removes the local state database, clears images in Nextcloud ({{ qdrant_collection }} collection), and optionally restores default environment values.</p>
  </section>

  <script>
    const searchResults = {{ (search_results or []) | tojson | safe }};
    let groupedResults = [];
    let activeGroup = null;
    let activePointIndex = null;
    let expandedGroups = new Set();
    let hasInitializedGroups = false;

    const metaPayload = (item) => item?.payload?.meta || item?.payload?.metadata || {};

    const baseName = (value) => {
      if (!value || typeof value !== 'string') return '';
      return value.split('/').filter(Boolean).pop() || value;
    };

    const extractFileId = (item) =>
      item?.payload?.file_id ||
      item?.payload?.fileId ||
      metaPayload(item)?.file_id ||
      metaPayload(item)?.fileId ||
      'unknown';

    const extractDocumentName = (item) =>
      item?.payload?.document_name ||
      item?.payload?.documentName ||
      metaPayload(item)?.document_name ||
      metaPayload(item)?.documentName ||
      baseName(item?.payload?.file_name) ||
      baseName(metaPayload(item)?.file_name) ||
      baseName(metaPayload(item)?.filename) ||
      baseName(item?.payload?.path) ||
      baseName(metaPayload(item)?.path) ||
      '';

    const extractTempName = (item) =>
      item?.payload?.temp_name ||
      item?.payload?.tempName ||
      item?.payload?.slug ||
      metaPayload(item)?.temp_name ||
      metaPayload(item)?.tempName ||
      metaPayload(item)?.slug ||
      '';

    function buildGroupedResults(results) {
      const groups = {};
      results.forEach((item, idx) => {
        const fileId = extractFileId(item);
        if (!groups[fileId]) {
          groups[fileId] = {
            fileId,
            documentName: extractDocumentName(item),
            tempName: extractTempName(item),
            points: [],
          };
        }
        const docName = extractDocumentName(item);
        const tempName = extractTempName(item);
        if (!groups[fileId].documentName && docName) {
          groups[fileId].documentName = docName;
        }
        if (!groups[fileId].tempName && tempName) {
          groups[fileId].tempName = tempName;
        }
        groups[fileId].points.push({ item, originalIndex: idx });
      });
      return Object.values(groups);
    }

    function showResultDetails(index, updateSelection = true) {
      const detail = document.getElementById('detail-content');
      if (!searchResults || !searchResults.length) {
        detail.textContent = 'No results available.';
        return;
      }
      const item = searchResults[index];
      if (!item) {
        detail.textContent = 'Result not found.';
        return;
      }
      const fileId = extractFileId(item);
      const docName = extractDocumentName(item) || 'Unknown document';
      const tempName = extractTempName(item) || 'Unknown temp name';
      const prettyPayload = JSON.stringify(item.payload || {}, null, 2);
      detail.innerHTML = '';
      const summary = document.createElement('div');
      summary.innerHTML = `<strong>Point ID:</strong> ${item.id}<br/><strong>Score:</strong> ${item.score}<br/><strong>File ID:</strong> ${fileId}<br/><strong>Document:</strong> ${docName}<br/><strong>Temp name:</strong> ${tempName}`;
      const payloadBlock = document.createElement('pre');
      payloadBlock.textContent = prettyPayload;
      detail.appendChild(summary);
      detail.appendChild(payloadBlock);
      if (updateSelection) {
        activePointIndex = index;
        activeGroup = fileId;
        expandedGroups.add(fileId);
        renderResults();
      }
    }

    function selectGroup(fileId) {
      const group = groupedResults.find((g) => g.fileId === fileId);
      if (!group) return;

      const isExpanded = expandedGroups.has(fileId);
      if (isExpanded) {
        expandedGroups.delete(fileId);
        if (activeGroup === fileId) {
          activeGroup = null;
        }
        if (group.points.some((p) => p.originalIndex === activePointIndex)) {
          activePointIndex = null;
        }
      } else {
        expandedGroups.add(fileId);
        activeGroup = fileId;
        activePointIndex = group.points?.[0]?.originalIndex ?? activePointIndex;
      }

      renderResults();
      if (!isExpanded && activePointIndex !== null) {
        showResultDetails(activePointIndex, false);
      }
    }

    function renderResults() {
      const container = document.getElementById('results-area');
      if (!searchResults || !searchResults.length) {
        container.innerHTML = '<div class="flash">No results yet.</div>';
        return;
      }

      groupedResults = buildGroupedResults(searchResults);
      const availableGroupIds = new Set(groupedResults.map((g) => g.fileId));
      expandedGroups = new Set([...expandedGroups].filter((id) => availableGroupIds.has(id)));

      if (!hasInitializedGroups && groupedResults.length) {
        expandedGroups.add(groupedResults[0].fileId);
        activeGroup = groupedResults[0].fileId;
        hasInitializedGroups = true;
      }

      const activeGroupId = activeGroup || [...expandedGroups][0] || null;
      const currentGroup = groupedResults.find((g) => g.fileId === activeGroupId);
      if (currentGroup && currentGroup.points.length) {
        const hasActivePoint = currentGroup.points.some((p) => p.originalIndex === activePointIndex);
        if (!hasActivePoint) {
          activePointIndex = currentGroup.points[0].originalIndex;
        }
      }

      container.innerHTML = '';
      const list = document.createElement('ul');
      list.className = 'results-list';

      groupedResults.forEach((group) => {
        const groupItem = document.createElement('li');
        groupItem.className = 'result-group';

        const header = document.createElement('button');
        header.type = 'button';
        header.className = 'group-header';
        header.onclick = () => selectGroup(group.fileId);

        const meta = document.createElement('div');
        meta.className = 'group-meta';
        meta.innerHTML = `<div class="group-title"><strong>${group.fileId}</strong> — ${group.documentName || 'Unknown document'} — ${group.tempName || 'Unknown temp name'}</div>` +
          `<div class="group-sub">Click to show points for this file</div>`;

        const pill = document.createElement('span');
        pill.className = 'toggle-pill';
        const isExpanded = expandedGroups.has(group.fileId);
        pill.textContent = isExpanded ? 'Hide points' : 'Show points';

        header.appendChild(meta);
        header.appendChild(pill);

        const pointsWrapper = document.createElement('div');
        pointsWrapper.style.display = isExpanded ? 'block' : 'none';

        const pointsList = document.createElement('ul');
        pointsList.className = 'points-list';
        group.points.forEach((point) => {
          const pointLi = document.createElement('li');
          const pointBtn = document.createElement('button');
          pointBtn.type = 'button';
          pointBtn.className = 'point-item';
          if (activePointIndex === point.originalIndex) {
            pointBtn.classList.add('active');
          }
          pointBtn.onclick = () => showResultDetails(point.originalIndex);
          pointBtn.innerHTML = `<div class="point-title">Point ID: ${point.item.id}</div>` +
            `<div class="point-sub">Score: ${point.item.score ?? 'n/a'}</div>`;
          pointLi.appendChild(pointBtn);
          pointsList.appendChild(pointLi);
        });

        pointsWrapper.appendChild(pointsList);
        groupItem.appendChild(header);
        groupItem.appendChild(pointsWrapper);
        list.appendChild(groupItem);
      });

      container.appendChild(list);

      if (activePointIndex !== null) {
        showResultDetails(activePointIndex, false);
      }
    }

    if (searchResults && searchResults.length) {
      renderResults();
    } else {
      const container = document.getElementById('results-area');
      container.innerHTML = '<div class="flash">No results yet.</div>';
    }

    async function refreshLog() {
      try {
        const res = await fetch('{{ url_for('log_data') }}');
        if (!res.ok) return;
        const data = await res.json();
        const logBox = document.getElementById('log-display');
        if (logBox && data.log !== undefined) {
          logBox.value = data.log;
        }
      } catch (e) {
        // ignore fetch errors in UI
      }
    }
    setInterval(refreshLog, 4000);
  </script>
</body>
</html>
