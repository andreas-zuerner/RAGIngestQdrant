<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>RAG Control Panel</title>
  <style>
    :root {
      --bg: #f4f6f8;
      --text: #1f2933;
      --section-bg: #ffffff;
      --border: #d6d6d6;
      --muted: #4a5568;
      --flash-bg: #eef5ff;
      --flash-border: #b3d0ff;
      --accent: #1d4ed8;
      --accent-contrast: #ffffff;
      --shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }
    body.dark {
      --bg: #0f172a;
      --text: #e5e7eb;
      --section-bg: #111827;
      --border: #27303f;
      --muted: #cbd5e1;
      --flash-bg: #1f2937;
      --flash-border: #374151;
      --accent: #3b82f6;
      --accent-contrast: #0b1221;
      --shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }
    body { font-family: Arial, sans-serif; margin: 20px; background: var(--bg); color: var(--text); }
    h1 { margin: 0; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; gap: 12px; }
    .header-actions { display: flex; align-items: center; gap: 16px; }
    .scheduler-actions { display: flex; gap: 10px; align-items: center; }
    .scheduler-actions form { margin: 0; }
    button { cursor: pointer; border-radius: 6px; padding: 8px 12px; border: 1px solid var(--border); background: var(--section-bg); color: var(--text); transition: background 0.2s, transform 0.1s; }
    button:hover { background: rgba(0, 0, 0, 0.04); }
    button:active { transform: translateY(1px); }
    .scheduler-actions button { padding: 12px 18px; font-size: 1rem; border: 1px solid var(--accent); background: var(--accent); color: var(--accent-contrast); box-shadow: var(--shadow); }
    .scheduler-actions button:hover { opacity: 0.94; }
    .theme-toggle { display: flex; align-items: center; gap: 8px; font-weight: 600; }
    .theme-label { color: var(--muted); font-weight: 500; }
    .switch { position: relative; display: inline-block; width: 48px; height: 26px; }
    .switch input { display: none; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: 0.4s; border-radius: 26px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: #fff; transition: 0.4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(22px); }
    section { background: var(--section-bg); border-radius: 8px; padding: 16px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); }
    form { margin-bottom: 8px; }
    textarea { width: 100%; height: 240px; background: var(--section-bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid var(--border); }
    .flash { background: var(--flash-bg); border: 1px solid var(--flash-border); padding: 8px; margin-bottom: 6px; }
    .env-table th:nth-child(1), .env-table td:nth-child(1) { width: 20%; }
    .env-table th:nth-child(2), .env-table td:nth-child(2) { width: 20%; }
    .env-table th:nth-child(3), .env-table td:nth-child(3) { width: 60%; }
    .env-table input { width: 100%; box-sizing: border-box; background: var(--section-bg); color: var(--text); border: 1px solid var(--border); border-radius: 6px; padding: 6px; }
    .env-desc { color: var(--muted); font-size: 0.95em; }
    .grid-two { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
    .grid-prompts-log { display: grid; grid-template-columns: 0.4fr 0.6fr; gap: 16px; align-items: stretch; }
    @media (max-width: 900px) { .grid-prompts-log { grid-template-columns: 1fr; } }
    .grid-prompts-log section { display: flex; flex-direction: column; height: 100%; }
    .prompt-area form { display: flex; flex-direction: column; gap: 8px; height: 100%; }
    .search-layout { display: grid; grid-template-columns: 2fr 3fr; gap: 16px; align-items: start; }
    .search-box { display: flex; flex-direction: column; gap: 8px; }
    .results-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
    .result-group { border: 1px solid var(--border); background: var(--section-bg); border-radius: 6px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
    .group-header { width: 100%; text-align: left; display: flex; justify-content: space-between; gap: 8px; align-items: center; padding: 10px; background: var(--flash-bg); border: none; cursor: pointer; color: var(--text); }
    .group-header:hover { background: rgba(147, 197, 253, 0.3); }
    .group-meta { display: flex; flex-direction: column; gap: 2px; }
    .group-title { font-weight: bold; }
    .group-sub { color: var(--muted); font-size: 0.9em; }
    .toggle-pill { background: #dbeafe; color: #1d4ed8; border: 1px solid #bfdbfe; border-radius: 12px; padding: 4px 8px; font-size: 0.85em; }
    .points-list { list-style: none; padding: 0 10px 10px 10px; margin: 0; display: flex; flex-direction: column; gap: 6px; }
    .point-item { width: 100%; text-align: left; border: 1px solid var(--border); background: var(--section-bg); border-radius: 6px; padding: 8px; cursor: pointer; transition: border-color 0.2s, background 0.2s; color: var(--text); }
    .point-item:hover { border-color: #8ab4f8; background: rgba(226, 232, 240, 0.35); }
    .point-item.active { border-color: var(--accent); background: rgba(59, 130, 246, 0.15); }
    .point-title { font-weight: bold; }
    .point-sub { color: var(--muted); font-size: 0.9em; }
    .detail-panel { border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: var(--section-bg); min-height: 220px; white-space: pre-wrap; word-break: break-word; }
    .detail-panel pre { white-space: pre-wrap; word-break: break-word; }
    #detail-content { white-space: pre-wrap; word-break: break-word; }
    .detail-header { font-weight: bold; margin-bottom: 6px; }
    .textarea-log { height: 100%; min-height: 360px; flex: 1; }
    .prompt-area textarea { height: 160px; }
    .delete-dashboard { display: grid; grid-template-columns: 0.2fr 0.4fr 0.4fr; gap: 16px; align-items: start; }
    @media (max-width: 900px) { .delete-dashboard { grid-template-columns: 1fr; } }
    .worker-dashboard table { width: 100%; border-collapse: collapse; }
    .worker-dashboard th, .worker-dashboard td { padding: 8px; border-bottom: 1px solid var(--border); }
    .worker-dashboard th { text-align: left; color: var(--muted); }
    .worker-empty { color: var(--muted); margin: 0; }
    .pipeline-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px; }
    .pipeline-stack { display: flex; flex-direction: column; gap: 12px; }
  </style>
</head>
  <body>
    <div class="header">
      <h1>RAG Control Panel</h1>
      <div class="header-actions">
        <div class="theme-toggle">
          <span class="theme-label" id="theme-label">Light mode</span>
          <label class="switch" aria-label="Toggle theme">
            <input type="checkbox" id="theme-switch" />
            <span class="slider"></span>
          </label>
        </div>
        <div class="scheduler-actions">
          <form method="post" action="{{ url_for('start_scheduler') }}">
            <button type="submit">Start scheduler</button>
          </form>
          <form method="post" action="{{ url_for('stop_scheduler') }}">
            <button type="submit">Stop scheduler</button>
          </form>
        </div>
      </div>
    </div>
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for msg in messages %}<div class="flash">{{ msg }}</div>{% endfor %}
    {% endif %}
  {% endwith %}

  <div class="grid-prompts-log">
    <section class="prompt-area">
      <h2>Prompts</h2>
      <form method="post" action="{{ url_for('update_prompts') }}">
        <label for="prompt_relevance">Relevance prompt</label>
        <textarea id="prompt_relevance" name="prompt_relevance">{{ prompts.relevance }}</textarea>
        <label for="prompt_chunking">Chunking prompt</label>
        <textarea id="prompt_chunking" name="prompt_chunking">{{ prompts.chunking }}</textarea>
        <label for="prompt_context">Context prompt</label>
        <textarea id="prompt_context" name="prompt_context">{{ prompts.context }}</textarea>
        <button type="submit">Save prompts</button>
      </form>
    </section>

    <section class="log-area">
      <h2>Log (latest 50 lines, newest first)</h2>
      <textarea class="textarea-log" id="log-display" readonly>{{ log_preview }}</textarea>
    </section>
  </div>

  <section>
    <h2>Search Qdrant ({{ qdrant_collection }})</h2>
    <div class="search-layout">
      <div class="search-box">
        <form method="post" action="{{ url_for('search') }}">
          <label>Document name contains:</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="text" name="search_term" value="{{ search_term or '' }}" style="flex:1" />
            <button type="submit">Search</button>
          </div>
        </form>
        {% if search_error %}
          <div class="flash">{{ search_error }}</div>
        {% endif %}
        <div id="results-area"></div>
      </div>

      <div>
        <div class="detail-panel" id="result-detail">
          <div class="detail-header">Result details</div>
          <div id="detail-content">Select a result to view its payload.</div>
        </div>
      </div>
    </div>
  </section>

  <div class="delete-dashboard">
    <section>
      <h2>Delete by file_id</h2>
      <form method="post" action="{{ url_for('delete_file') }}">
        <input type="text" name="file_id" placeholder="file_id" />
        <button type="submit">Delete</button>
      </form>
      <p>Removes Qdrant points, marks the entry in state.db, and deletes matching images in Nextcloud (documents remain unchanged).</p>
    </section>

    <section class="worker-dashboard">
      <div class="pipeline-header">
        <h2 style="margin: 0;">Pipeline dashboard</h2>
        <button type="button" id="pipeline-refresh">Refresh</button>
      </div>
      <div class="pipeline-stack">
        <div>
          <h3>Queued by scheduler</h3>
          {% if pipeline_overview.queued %}
            <ul class="results-list">
              {% for job in pipeline_overview.queued %}
                <li class="point-item">
                  <div class="point-title">{{ job.file_id }}</div>
                  <div class="point-sub">Path: {{ job.path }}</div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="worker-empty">No queued files.</p>
          {% endif %}
        </div>
        <div>
          <h3>Docling in progress ({{ pipeline_overview.docling|length }})</h3>
          {% if pipeline_overview.docling %}
            <ul class="results-list">
              {% for job in pipeline_overview.docling %}
                <li class="point-item">
                  <div class="point-title">{{ job.file_id }}</div>
                  <div class="point-sub">Path: {{ job.path }}</div>
                  <div class="point-sub">Worker: {{ job.worker_id or 'n/a' }}</div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="worker-empty">No docling tasks running.</p>
          {% endif %}
        </div>
      </div>
    </section>

    <section class="worker-dashboard">
      <div class="pipeline-stack">
        <div>
          <h3>Extracted (awaiting pipeline)</h3>
          {% if pipeline_overview.extracted %}
            <ul class="results-list">
              {% for job in pipeline_overview.extracted %}
                <li class="point-item">
                  <div class="point-title">{{ job.file_id }}</div>
                  <div class="point-sub">Path: {{ job.path }}</div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="worker-empty">No extracted files waiting.</p>
          {% endif %}
        </div>
        <div>
          <h3>Pipeline processing</h3>
          {% if pipeline_overview.pipeline %}
            <ul class="results-list">
              {% for job in pipeline_overview.pipeline %}
                <li class="point-item">
                  <div class="point-title">{{ job.file_id }}</div>
                  <div class="point-sub">Path: {{ job.path }}</div>
                  <div class="point-sub">Stage: {{ job.stage_label or 'relevance' }}</div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="worker-empty">No files in post-extraction pipeline.</p>
          {% endif %}
        </div>
      </div>
    </section>
  </div>

  <section>
    <h2>Environment variables</h2>
    <form method="post" action="{{ url_for('update_env') }}">
      <table class="env-table">
        <thead>
          <tr>
            <th>Variable name</th>
            <th>Current value</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for key, value in env_values.items() %}
          <tr>
            <td><input type="text" readonly value="{{ key }}" /></td>
            <td><input type="text" name="env_{{ key }}" value="{{ value }}" /></td>
            <td class="env-desc">{{ env_descriptions.get(key, '') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <button type="submit">Update .env.local</button>
    </form>
    <form method="post" action="{{ url_for('add_env_var') }}">
      <input type="text" name="new_key" placeholder="NEW_KEY" />
      <input type="text" name="new_value" placeholder="value" />
      <button type="submit">Add variable</button>
    </form>
    <details>
      <summary>Currently active environment</summary>
      <pre>{{ current_env|format_payload }}</pre>
    </details>
  </section>

  <section>
    <h2>Reset RAG</h2>
    <form method="post" action="{{ url_for('reset_all') }}">
      <label><input type="checkbox" name="restore_defaults" /> Restore defaults from .env.local.example</label><br/>
      <button type="submit" onclick="return confirm('This will delete Qdrant data, state.db, and Nextcloud images. Continue?');">Reset everything</button>
    </form>
    <p>Deletes all Qdrant entries, removes the local state database, clears images in Nextcloud ({{ qdrant_collection }} collection), and optionally restores default environment values.</p>
  </section>

    <script>
      const themeSwitch = document.getElementById('theme-switch');
      const themeLabel = document.getElementById('theme-label');

      const applyTheme = (mode) => {
        document.body.classList.toggle('dark', mode === 'dark');
        if (themeLabel) {
          themeLabel.textContent = mode === 'dark' ? 'Dark mode' : 'Light mode';
        }
        localStorage.setItem('theme', mode);
      };

      const savedTheme = localStorage.getItem('theme') === 'dark' ? 'dark' : 'light';
      applyTheme(savedTheme);
      if (themeSwitch) {
        themeSwitch.checked = savedTheme === 'dark';
        themeSwitch.addEventListener('change', (event) => {
          applyTheme(event.target.checked ? 'dark' : 'light');
        });
      }

      const searchResults = {{ (search_results or []) | tojson | safe }};
    let groupedResults = [];
    let activeGroup = null;
    let activePointIndex = null;
    let expandedGroups = new Set();
    let hasInitializedGroups = false;

    const metaPayload = (item) => item?.payload?.meta || item?.payload?.metadata || {};

    const baseName = (value) => {
      if (!value || typeof value !== 'string') return '';
      return value.split('/').filter(Boolean).pop() || value;
    };

    const extractFileId = (item) =>
      item?.payload?.file_id ||
      item?.payload?.fileId ||
      metaPayload(item)?.file_id ||
      metaPayload(item)?.fileId ||
      'unknown';

    const extractDocumentName = (item) =>
      item?.payload?.document_name ||
      item?.payload?.documentName ||
      metaPayload(item)?.document_name ||
      metaPayload(item)?.documentName ||
      baseName(item?.payload?.file_name) ||
      baseName(metaPayload(item)?.file_name) ||
      baseName(metaPayload(item)?.filename) ||
      baseName(item?.payload?.path) ||
      baseName(metaPayload(item)?.path) ||
      '';

    const extractTempName = (item) =>
      item?.payload?.temp_name ||
      item?.payload?.tempName ||
      item?.payload?.slug ||
      metaPayload(item)?.temp_name ||
      metaPayload(item)?.tempName ||
      metaPayload(item)?.slug ||
      '';

    function buildGroupedResults(results) {
      const groups = {};
      results.forEach((item, idx) => {
        const fileId = extractFileId(item);
        if (!groups[fileId]) {
          groups[fileId] = {
            fileId,
            documentName: extractDocumentName(item),
            tempName: extractTempName(item),
            points: [],
          };
        }
        const docName = extractDocumentName(item);
        const tempName = extractTempName(item);
        if (!groups[fileId].documentName && docName) {
          groups[fileId].documentName = docName;
        }
        if (!groups[fileId].tempName && tempName) {
          groups[fileId].tempName = tempName;
        }
        groups[fileId].points.push({ item, originalIndex: idx });
      });
      return Object.values(groups);
    }

    function showResultDetails(index, updateSelection = true) {
      const detail = document.getElementById('detail-content');
      if (!searchResults || !searchResults.length) {
        detail.textContent = 'No results available.';
        return;
      }
      const item = searchResults[index];
      if (!item) {
        detail.textContent = 'Result not found.';
        return;
      }
      const fileId = extractFileId(item);
      const docName = extractDocumentName(item) || 'Unknown document';
      const tempName = extractTempName(item) || 'Unknown temp name';
      const prettyPayload = JSON.stringify(item.payload || {}, null, 2);
      detail.innerHTML = '';
      const summary = document.createElement('div');
      summary.innerHTML = `<strong>Point ID:</strong> ${item.id}<br/><strong>Score:</strong> ${item.score}<br/><strong>File ID:</strong> ${fileId}<br/><strong>Document:</strong> ${docName}<br/><strong>Temp name:</strong> ${tempName}`;
      const payloadBlock = document.createElement('pre');
      payloadBlock.textContent = prettyPayload;
      detail.appendChild(summary);
      detail.appendChild(payloadBlock);
      if (updateSelection) {
        activePointIndex = index;
        activeGroup = fileId;
        expandedGroups.add(fileId);
        renderResults();
      }
    }

    function selectGroup(fileId) {
      const group = groupedResults.find((g) => g.fileId === fileId);
      if (!group) return;

      const isExpanded = expandedGroups.has(fileId);
      if (isExpanded) {
        expandedGroups.delete(fileId);
        if (activeGroup === fileId) {
          activeGroup = null;
        }
        if (group.points.some((p) => p.originalIndex === activePointIndex)) {
          activePointIndex = null;
        }
      } else {
        expandedGroups.add(fileId);
        activeGroup = fileId;
        activePointIndex = group.points?.[0]?.originalIndex ?? activePointIndex;
      }

      renderResults();
      if (!isExpanded && activePointIndex !== null) {
        showResultDetails(activePointIndex, false);
      }
    }

    function renderResults() {
      const container = document.getElementById('results-area');
      if (!searchResults || !searchResults.length) {
        container.innerHTML = '<div class="flash">No results yet.</div>';
        return;
      }

      groupedResults = buildGroupedResults(searchResults);
      const availableGroupIds = new Set(groupedResults.map((g) => g.fileId));
      expandedGroups = new Set([...expandedGroups].filter((id) => availableGroupIds.has(id)));

      if (!hasInitializedGroups && groupedResults.length) {
        expandedGroups.add(groupedResults[0].fileId);
        activeGroup = groupedResults[0].fileId;
        hasInitializedGroups = true;
      }

      const activeGroupId = activeGroup || [...expandedGroups][0] || null;
      const currentGroup = groupedResults.find((g) => g.fileId === activeGroupId);
      if (currentGroup && currentGroup.points.length) {
        const hasActivePoint = currentGroup.points.some((p) => p.originalIndex === activePointIndex);
        if (!hasActivePoint) {
          activePointIndex = currentGroup.points[0].originalIndex;
        }
      }

      container.innerHTML = '';
      const list = document.createElement('ul');
      list.className = 'results-list';

      groupedResults.forEach((group) => {
        const groupItem = document.createElement('li');
        groupItem.className = 'result-group';

        const header = document.createElement('button');
        header.type = 'button';
        header.className = 'group-header';
        header.onclick = () => selectGroup(group.fileId);

        const meta = document.createElement('div');
        meta.className = 'group-meta';
        meta.innerHTML = `<div class="group-title"><strong>${group.fileId}</strong> — ${group.documentName || 'Unknown document'} — ${group.tempName || 'Unknown temp name'}</div>` +
          `<div class="group-sub">Click to show points for this file</div>`;

        const pill = document.createElement('span');
        pill.className = 'toggle-pill';
        const isExpanded = expandedGroups.has(group.fileId);
        pill.textContent = isExpanded ? 'Hide points' : 'Show points';

        header.appendChild(meta);
        header.appendChild(pill);

        const pointsWrapper = document.createElement('div');
        pointsWrapper.style.display = isExpanded ? 'block' : 'none';

        const pointsList = document.createElement('ul');
        pointsList.className = 'points-list';
        group.points.forEach((point) => {
          const pointLi = document.createElement('li');
          const pointBtn = document.createElement('button');
          pointBtn.type = 'button';
          pointBtn.className = 'point-item';
          if (activePointIndex === point.originalIndex) {
            pointBtn.classList.add('active');
          }
          pointBtn.onclick = () => showResultDetails(point.originalIndex);
          pointBtn.innerHTML = `<div class="point-title">Point ID: ${point.item.id}</div>` +
            `<div class="point-sub">Score: ${point.item.score ?? 'n/a'}</div>`;
          pointLi.appendChild(pointBtn);
          pointsList.appendChild(pointLi);
        });

        pointsWrapper.appendChild(pointsList);
        groupItem.appendChild(header);
        groupItem.appendChild(pointsWrapper);
        list.appendChild(groupItem);
      });

      container.appendChild(list);

      if (activePointIndex !== null) {
        showResultDetails(activePointIndex, false);
      }
    }

    if (searchResults && searchResults.length) {
      renderResults();
    } else {
      const container = document.getElementById('results-area');
      container.innerHTML = '<div class="flash">No results yet.</div>';
    }

    async function refreshLog() {
      try {
        const res = await fetch('{{ url_for('log_data') }}');
        if (!res.ok) return;
        const data = await res.json();
        const logBox = document.getElementById('log-display');
        if (logBox && data.log !== undefined) {
          logBox.value = data.log;
        }
      } catch (e) {
        // ignore fetch errors in UI
      }
    }
    setInterval(refreshLog, 4000);

    const pipelineRefresh = document.getElementById('pipeline-refresh');
    if (pipelineRefresh) {
      pipelineRefresh.addEventListener('click', () => {
        window.location.reload();
      });
    }
  </script>
</body>
</html>
